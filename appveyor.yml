
version: 1.0.{build}.{branch}

image: Visual Studio 2015

# Do not build on tags (GitHub and BitBucket)
skip_tags: true

# Start builds on tags only (GitHub and BitBucket)
# skip_non_tags: true

# branches:
#   only:
#     - master

# Skipping commits affecting specific files (GitHub only).
skip_commits:
  files:
    - '**/*.md'
  message: /\[skip ci]/

# set clone depth
clone_depth: 1


environment:
  APPVEYOR_SAVE_CACHE_ON_ERROR: true

  # note: master, 13.0.0-0, 12.0.0-0 , 11.0.0-0 (exactly) will
  #  1. attempt to compile from pg source code
  #  AND
  #  2. run the "patch" on msvc.*.diff
  #  3. build

  # all, other numbered version will either
  #  1. run upon appveyor pg
  #  2. if on appveyor that version of PG is not available,
  #     then, from enterprisedb, download the install binary, install
  #  3. build partially


  # desire to make a look like b
  #
  # $ diff -u a.txt b.txt > patchab.patch
  # $ patch -b -r a.txt.rej a.txt -i patchab.patch
  #patching file a.txt
  #
  # consider - msvc.diff . . . CREATION
  #
  # git diff HEAD~1:source.ext HEAD:target.ext
  # or
  # git diff HEAD~1:source.ext      source.ext
  #
  # see  msvc.diff
  # see  compilingplr.md
  #
  # https://stackoverflow.com/questions/16683121/git-diff-between-two-different-files
  # https://git-scm.com/docs/git-diff
  # https://stackoverflow.com/questions/19224476/how-does-index-f2e4113-d4b9bfc-100644-in-git-diff-correspond-to-sha1-id-in-gi


  # consider
  #
  # Use MSBuild to upgrade and build a sln
  # https://stackoverflow.com/questions/8842952/use-msbuild-to-upgrade-and-build-a-sln
  #
  # /Upgrade (devenv.exe)
  # https://docs.microsoft.com/en-us/previous-versions/visualstudio/visual-studio-2015/ide/reference/upgrade-devenv-exe?view=vs-2015&redirectedfrom=MSDN
  #
  # C:\projects\postgresql\pgsql.sln

  #
  # BEGIN history
  #

  # commit - seems pg 12 + "pg 13 in master in development"
  # * matrix updated + add PG 12.4-1
  #
  #  - pg: master
  #    PlatformToolset: v141
  #    configuration: Debug
  #    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
  #  - pg: 9.5.23-1
  #    PlatformToolset: v120
  #  - pg: 9.6.19-1
  #    PlatformToolset: v120
  #  - pg: 10.14-1
  #    PlatformToolset: v120
  #  - pg: 11.9-1
  #    PlatformToolset: v140
  #  - pg: 12.4-1
  #    PlatformToolset: v141
  #
  # Sep 8, 2020
  # https://github.com/postgres-plr/plr/blame/aa781da032d8b1ad91a3d03cd6219eea9b8abbaa/appveyor.yml

  # Release date: 2019-10-03
  # https://www.postgresql.org/docs/release/12.0/

  # commit - seems pg 11 + "pg 12 in master in development"
  # just change in 1. matrix numbers 2.  R version updated
  #
  #  - pg: master
  #    PlatformToolset: v141
  #    configuration: Debug
  #    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
  #  - pg: 9.4.22-1
  #    PlatformToolset: v120
  #  - pg: 9.5.17-1
  #    PlatformToolset: v120
  #  - pg: 9.6.13-1
  #    PlatformToolset: v120
  #  - pg: 10.8-1
  #    PlatformToolset: v120
  #  - pg: 11.3-1
  #    PlatformToolset: v140
  #
  # May 23, 2019
  # https://github.com/postgres-plr/plr/blame/c82fe1984b51f53ce7a4ad6853815bc9554fa390/appveyor.yml
  #
  # May 23, 2019 + adds inline handler c code + matrix updated
  #  - pg: master
  #    PlatformToolset: v141
  #    configuration: Debug
  #    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
  #  - pg: 9.3.25-1
  #    PlatformToolset: Windows7.1SDK
  #  - pg: 9.4.21-1
  #    PlatformToolset: v120
  #  - pg: 9.5.16-1
  #    PlatformToolset: v120
  #  - pg: 9.6.12-1
  #    PlatformToolset: v120
  #  - pg: 10.7-1
  #    PlatformToolset: v120
  #  - pg: 11.2-1
  #    PlatformToolset: v140
  #
  # https://github.com/postgres-plr/plr/blame/786bd6a0edb0a8273b28b3b0ec03971404fdf157/appveyor.yml

  # plr.vcxproj
  # one commit ever
  # Dec 11, 2018 - pg 11 just released - blob/blame - tree
  #  <VCProjectVersion>15.0</VCProjectVersion>
  # https://github.com/postgres-plr/plr/blob/c42eb9ce0b52a92a1d075e927db26a914100a860/plr.vcxproj
  # https://github.com/postgres-plr/plr/blame/c42eb9ce0b52a92a1d075e927db26a914100a860/plr.vcxproj
  # https://github.com/postgres-plr/plr/tree/c42eb9ce0b52a92a1d075e927db26a914100a860
  #
  # Dec 11, 2018
  # https://github.com/postgres-plr/plr/blob/c42eb9ce0b52a92a1d075e927db26a914100a860/msvc.diff
  # https://github.com/postgres-plr/plr/blame/c42eb9ce0b52a92a1d075e927db26a914100a860/msvc.diff

  # Dec 11, 2018 - matrix stays the same as below + compiling becomes "better"
  # #
  # This PR allows to build, install, and debug PL/R with MS Visual Studio much faster provided
  #   PG, R, and RTools are already installed
  # https://github.com/postgres-plr/plr/pull/48
  # #
  # https://github.com/postgres-plr/plr/blame/1482fcd33860d1687139f847637cb58177f8bc58/appveyor.yml
  #
  # Dec 11, 2018 - massive overhaul - matrix first apprears - seems pg 11 + "pg 12 in master in development"
  #  - pg: master
  #    PlatformToolset: v141
  #    configuration: Debug
  #    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
  #  - pg: 9.3.24-1
  #    PlatformToolset: Windows7.1SDK
  #  - pg: 9.4.19-1
  #    PlatformToolset: v120
  #  - pg: 9.5.15-1
  #    PlatformToolset: v120
  #  - pg: 9.6.11-1
  #    PlatformToolset: v120
  #  - pg: 10.6-1
  #    PlatformToolset: v120
  #  - pg: 11.1-1
  #    PlatformToolset: v140
  #
  # 1. detect numbered versions of pg in appveyor, and if there, use that do partial build/packaging
  # 2. if (.1) not found, then download from enterprisedb, and install, use that do partial build/packaging
  # https://github.com/postgres-plr/plr/blame/1482fcd33860d1687139f847637cb58177f8bc58/appveyor.yml

  # Release date: 2018-10-18
  # https://www.postgresql.org/docs/release/11.0/

  # Sep 30, 2018
  # https://github.com/postgres-plr/plr/blob/060c6c120591fd160c45a1b7514fa5ea3c76e4d8/msvc.diff
  # https://github.com/postgres-plr/plr/blame/060c6c120591fd160c45a1b7514fa5ea3c76e4d8/msvc.diff

  # Sep 30, 2018 - same as below + add test for "create procedure"
  # https://github.com/postgres-plr/plr/blame/e1eda05ffc71850cba6d1bf888394d46fd06dabf/appveyor.yml

  # Jan 30, 2018 - builds master from source - like below + adds and uses some rtoonls binaries
  # https://github.com/postgres-plr/plr/blame/e65319fd9a6d2648122e85ceff863c132ab6ce77/appveyor.yml

  # Nov 9, 2017 - original commit
  # https://github.com/postgres-plr/plr/blob/e65319fd9a6d2648122e85ceff863c132ab6ce77/msvc.diff
  # https://github.com/postgres-plr/plr/blame/e65319fd9a6d2648122e85ceff863c132ab6ce77/msvc.diff

  # Nov 9, 2017 - original commit - builds master from source
  # https://github.com/postgres-plr/plr/blame/483510028a1a99e7895eb262944fda161ac4f994/appveyor.yml

  # https://www.postgresql.org/docs/release/10.0/
  # Release date: 2017-10-05

  #
  # END history
  #

  # https://stackoverflow.com/questions/27517662/what-is-platform-toolset-setting-in-visual-studio-project
  # COMMENTS leads to . . .
  # https://en.wikipedia.org/wiki/Microsoft_Visual_C%2B%2B#Internal_version_numbering

  matrix:

  # compiling
  
  # msvc.pg.13._try3.diff
  # my $plr = $solution->AddProject('plr','dll','plr');
  
  # msvc.pg.13._try2.diff (just like pgcrypto)
  # my $plr = $solution->AddProject('plr','dll','plr','contrib/plr');
  
  
  - pg: 13.0.0-0
    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
    PlatformToolset: v142
    platform: x64
    configuration: Release
    rversion: 4.0.3
    msvc_diff_file: msvc.pg.13._try3.diff
    USER_BUILD: MSVC


#     # install (may be causing the problem)? - no
#     # del plr.vcxproj.user
#     # del plr.vcxproj
#   
#     - pg: 13.0.0-0
#       APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#       PlatformToolset: v142
#       platform: x64
#       configuration: Release
#       rversion: 4.0.3
#       msvc_diff_file: msvc.pg.13._try2.diff
#       USER_BUILD: MSVC

  #
  # same as below - try Release mode
  # WORKS (STILL HAVE TO WORK AROUND MY HACK)
  # https://ci.appveyor.com/project/AndreMikulec/plr/builds/38429937/job/307r0q68adm2pas4?fullLog=true
  #
#     - pg: 13.0.0-0
#       APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
#       PlatformToolset: v141
#       platform: x64
#       configuration: Release
#       rversion: 4.0.3
#       msvc_diff_file: msvc.pg.13._try2.diff
#       USER_BUILD: MSVC


#    # REMEMBER: MY VISUAL STUDIO 2019?? COMPLAINT ABOUT 2 "plr" PROJECTS - and then FAIL
#    #
#    # VISUAL STUDIO 2017 v141
#    # https://ci.appveyor.com/project/AndreMikulec/plr/builds/38429844/job/42jhb9xt8nwd6rms?fullLog=true
#    #
#    Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "pgcrypto", "pgcrypto.vcxproj", "{2E7DA664-372F-4534-85CE-0F153EAC10AF}"
#    EndProject
#    Project("{2150E333-8FDC-42A3-9474-1A3956D46DE8}") = "crypto", "crypto", "{76F4B6F3-E283-4813-80ED-BD098AF26695}"
#    EndProject
#
#    Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "plr", "plr.vcxproj", "{2BF6B23A-223F-45E2-A3CC-B5C539360B81}"
#    EndProject
#    Project("{2150E333-8FDC-42A3-9474-1A3956D46DE8}") = "plr", "plr", "{8D939891-27BA-47CB-A741-7239F3C92648}"
#    EndProject
#  #
#  # WORKS but I have to work fix, around my hack
#  #
#  # SUCCESS: Specified value was saved.
#  # net start postgresql%x64%-%pgversion%
#  # The service name is invalid.
#  # Command exited with code 2
#  #
#  - pg: 13.0.0-0
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
#    PlatformToolset: v141
#    platform: x64
#    configuration: Debug
#    rversion: 4.0.3
#    msvc_diff_file: msvc.pg.13._try2.diff
#    USER_BUILD: MSVC
#
#  #
#  # NOT WORK
   # C:\Program Files (x86)\MSBuild\Microsoft.Cpp\v4.0\V140\Microsoft.Cpp.Platform.targets(57,5):
   # error MSB8020: The build tools for v141 (Platform Toolset = 'v141') cannot be found.
   # To build using the v141 build tools, please install v141 build tools.
   # Alternatively, you may upgrade to the current Visual Studio tools by selecting the
   # Project menu or right-click the solution, and then selecting
   # "Retarget solution". [C:\projects\postgresql\pgevent.vcxproj]
#  #
#  # Visual Studio Platform 2015 Toolset ='v141' cannot be found
#
#  # Reason: When someone tries to open existing solution which created/build on latest
#  # VS version (VS2015 / 2017) and tried to open with backward / old version of VS instance.
#  # Then this error might occur.
#
#  # https://stackoverflow.com/questions/43312676/visual-studio-platform-2015-toolset-v141-cannot-be-found
#  #
#  - pg: 13.0.0-0
#    PlatformToolset: v141
#    platform: x64
#    configuration: Release
#    rversion: 4.0.3
#    msvc_diff_file: msvc.pg.13._try2.diff
#    USER_BUILD: MSVC


#####

#  - pg: 13.0.0-0
#    platform: x64
#    configuration: Release
#    rversion: 4.0.3
#    msvc_diff_file: msvc.pg.13._try2.diff
#    USER_BUILD: MSVC
#
#  - pg: 13.0.0-0
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x64
#    configuration: Release
#    rversion: 4.0.3
#    msvc_diff_file: msvc.pg.13._try2.diff
#    USER_BUILD: MSVC
#
#  # non-"from pg source code" build does not use msvc.diff
#  - pg: 13.2-1
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x64
#    configuration: Release
#    rversion: 4.0.3
#    msvc_diff_file: msvc.diff
#    USER_BUILD: MSVC
#
#  # non-"from pg source code" build does not use msvc.diff
#  - pg: 13.2-1
#    platform: x64
#    configuration: Release
#    rversion: 4.0.3
#    msvc_diff_file: msvc.diff
#    USER_BUILD: MSVC


#  - pg: 12.0.0-0
#    # APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    # PlatformToolset: v142
#    platform: x64
#    configuration: Release
#    rversion: 4.0.3
#    # does not work in 12.0.0-0
#    msvc_diff_file: msvc.diff
#    USER_BUILD: MSVC
#
#  - pg: 13.0.0-0
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x64
#    configuration: Release
#    rversion: 4.0.3
#    msvc_diff_file: msvc.pg.13._try2.diff
#    USER_BUILD: MSVC
#
##  # C:\projects\postgresql\pgsql.sln : Solution file error MSB5004: The solution file has two projects named "plr".
##  #
##  # MSBuild Error: The solution file has two projects named
##  # https://stackoverflow.com/questions/30760890/msbuild-error-the-solution-file-has-two-projects-named
##  - pg: 13.0.0-0
##    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
##    PlatformToolset: v142
##    platform: x64
##    configuration: Release
##    rversion: 4.0.3
##    msvc_diff_file: msvc.pg.13.diff
##    USER_BUILD: MSVC
#
#  - pg: 13.0.0-0
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x64
#    configuration: Release
#    rversion: 4.0.3
#    msvc_diff_file: msvc.pg.13.diff
#    USER_BUILD: MSVC
#
#  # just simple binding
#
#  - pg: 12.4-1
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x64
#    configuration: Release
#    rversion: 4.0.3
#    msvc_diff_file: msvc.diff
#    USER_BUILD: MSVC
#
#  - pg: 13.2-1
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x64
#    configuration: Release
#    rversion: 4.0.3
#    msvc_diff_file: msvc.pg.13.diff
#    USER_BUILD: MSVC
#
#  # compiling
#
#  - pg: 12.0.0-0
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x64
#    configuration: Release
#    rversion: 4.0.3
#    # does not work in 12.0.0-0
#    msvc_diff_file: msvc.diff
#    USER_BUILD: MSVC
#
#  ######################################
#
#  #
#  # ERROR - two plr solutions are found
#  #
#  - pg: master
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x64
#    configuration: Debug
#    rversion: 3.6.3
#    msvc_diff_file: msvc.pg.13.diff
#    USER_BUILD: MSVC
#
#  #
#  # current postgres and old R
#  #
#  - pg: 13.2-1
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x64
#    configuration: Release
#    rversion: 3.6.3
#    msvc_diff_file: msvc.pg.13.diff
#    USER_BUILD: MSVC
#
#  #
#  # ERROR - could not find the plr.dll
#  #
#  # current postgres and current R (and Debug configuration)
#  #
#  - pg: 13.2-1
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x64
#    configuration: Debug
#    rversion: 4.0.3
#    msvc_diff_file: msvc.pg.13.diff
#    USER_BUILD: MSVC
#
#  #
#  # current postgres and current R (older .diff)
#  #
#  - pg: 13.2-1
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x64
#    configuration: Release
#    rversion: 4.0.3
#    msvc_diff_file: msvc.diff
#    USER_BUILD: MSVC
#
#  #
#  # Last 32 bit Windows PG available and old R
#  # https://www.enterprisedb.com/downloads/postgres-postgresql-downloads
#  #
#  - pg: 10.16-1
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x86
#    configuration: Release
#    rversion: 3.6.3
#    msvc_diff_file: msvc.diff
#    USER_BUILD: MSVC
#
#  #
#  # Last 32 bit Windows PG available and current R
#  # https://www.enterprisedb.com/downloads/postgres-postgresql-downloads
#  #
#  - pg: 10.16-1
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x86
#    configuration: Release
#    rversion: 3.6.3
#    msvc_diff_file: msvc.diff
#    USER_BUILD: MSVC
#
#  - pg: 11.9-1
#    APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
#    PlatformToolset: v142
#    platform: x64
#    configuration: Release
#    rversion: 3.6.3
#    msvc_diff_file: msvc.diff
#    USER_BUILD: MSVC
#
#  - pg: 9.6.13-1
#    # image: Visual Studio 2015 # must! be at the ROOT
#    PlatformToolset: v120
#    platform: x64
#    configuration: Release
#    rversion: 3.6.3
#    msvc_diff_file: msvc.diff
#    USER_BUILD: MSVC

  - pg: master
    USER_BUILD: MSYS2

matrix:
  allow_failures:
    - pg: master

for:
-
  matrix:
    only:
      - USER_BUILD: MSVC

  environment:
    PGUSER: postgres
    PGPASSWORD: Password12!
    PGOPTIONS: -c log_error_verbosity=verbose -c log_min_messages=debug2 -c log_min_error_statement=debug2

  init: # Make %x64% available for caching
  - REM BEGIN init
  - if %PLATFORM%==x64 ( set pf=%ProgramFiles%&& set x64=-x64) else set pf=%ProgramFiles(x86)%
  - set exe=postgresql-%pg%-windows%x64%.exe
  - setx /m exe %exe%
  - REM END init

  install:
  - REM BEGIN install
  - echo no effect on the 2019 two plr project problem
  - move plr.vcxproj.user plr.vcxproj.user.hidden
  - move plr.vcxproj      plr.vcxproj.hidden
  - set
  - move %msvc_diff_file% msvc.diff
  - if not exist R-%rversion%-win.exe appveyor downloadfile https://cran.r-project.org/bin/windows/base/old/%rversion%/R-%rversion%-win.exe
  - R-%rversion%-win.exe /VERYSILENT
  # We could have used RTools many R users have, but let's use msys64 existing on Appveyor intead
  #- if not exist Rtools35.exe appveyor downloadfile https://cran.r-project.org/bin/windows/Rtools/Rtools35.exe
  #- Rtools35.exe /VERYSILENT
  - Set mingw=C:\msys64\mingw
  # http://www.databasesoup.com/2016/05/changing-postgresql-version-numbering.html
  - for /f "tokens=1 delims=-" %%A in ("%pg%") do set pgversion=%%~nA
  - echo pgversion=%pgversion%
  # https://stackoverflow.com/questions/32578014/how-to-extract-version-number-in-a-windows-batch-file/32578368
  # GREAT
  # https://stackoverflow.com/questions/37627248/how-to-split-a-command-over-multiple-lines-in-appveyor-yml
  - for /F "tokens=1,2,3 delims=." %%a in ("%pg%") do (
      set Major=%%a&
      set Minor=%%b&
      set Revision=%%c)
  - echo Major=%Major%
  - echo Minor=%Minor%
  - echo Revision=%Revision%
  # note - environment variable pgversion is Major.Minor
  - set pgroot=%pf%\PostgreSQL\%pgversion%
  - echo %pgroot%
  - SET R_HOME=%ProgramFiles%\R\R-%rversion%
  - set RBIN=%PLATFORM:x86=i386%
  - SET sed=C:\msys64\usr\bin\sed
  - ps: |
      Set-PSDebug -Trace 2
      if (("master", "13.0.0-0", "12.0.0-0", "11.0.0-0").Contains("$env:pg")) {
        dir "C:\Program Files (x86)"
        dir "C:\Program Files"
        # Visual Studio 2015 and 64 bit # I MAY WANT TO FIX THAT
        # https://en.wikipedia.org/wiki/Microsoft_Visual_Studio
        $env:Path += ";C:\msys64\usr\bin;C:\msys64\mingw64\bin;C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\bin\amd64"
        #
        if ("$env:pg" -eq "master") {
          git clone --depth 1 --single-branch --branch=master https://git.postgresql.org/git/postgresql.git c:\projects\postgresql
        }
        if (("13.0.0-0", "12.0.0-0", "11.0.0-0").Contains("$env:pg")) {
          # tag will create a "detached head", but the "detached head" is still is usefull
          git clone --depth 1 --single-branch --branch=REL_${env:Major}_0 https://git.postgresql.org/git/postgresql.git c:\projects\postgresql
        }
        #
        gendef - "$env:R_HOME\bin\$env:rbin\R.dll" > "R$env:PLATFORM.def" 2> $null
        lib "/def:R$env:PLATFORM.def" "/out:R$env:PLATFORM.lib" "/MACHINE:$env:PLATFORM"
        pushd c:\projects\postgresql
        cmd /c mklink /J contrib\plr $env:APPVEYOR_BUILD_FOLDER
        #
        copy          c:\projects\postgresql\src\tools\msvc\Mkvcbuild.pm c:\projects\postgresql\src\tools\msvc\Mkvcbuild.pm.before
        copy          c:\projects\postgresql\src\tools\msvc\vcregress.pl c:\projects\postgresql\src\tools\msvc\vcregress.pl.before
        #
        which patch
        patch --verbose -r msvc.diff.rej -p1 -i "$env:APPVEYOR_BUILD_FOLDER\msvc.diff"
        dir
        #
        # This file changes too often, do not bother to track it.  Just let "master" builds fail.
        # https://github.com/postgres/postgres/blame/master/src/tools/msvc/Mkvcbuild.pm

        # This file changes maybe once/year
        # https://github.com/postgres/postgres/blame/master/src/tools/msvc/vcregress.pl

        ### perl -c ### syntax and check if can compile ##
        echo BEGIN Mkvcbuild.pm
        C:\msys64\usr\bin\diff -u      c:\projects\postgresql\src\tools\msvc\Mkvcbuild.pm.before c:\projects\postgresql\src\tools\msvc\Mkvcbuild.pm
        echo END Mkvcbuild.pm
        type         c:\projects\postgresql\src\tools\msvc\Mkvcbuild.pm
        ### perl -c
        C:\msys64\usr\bin\diff -u      c:\projects\postgresql\src\tools\msvc\vcregress.pl.before c:\projects\postgresql\src\tools\msvc\vcregress.pl
        echo BEGIN vcregress.pl
        type         c:\projects\postgresql\src\tools\msvc\vcregress.pl
        echo END   vcregress.pl
        #
        if (Test-Path msvc.diff.rej){
           Get-Content msvc.diff.rej
           throw "Mkvcbuild.pm.rej patch is rejected"
        }
        # note perl calls functions in here . . .
        #
        # 1. detects - visualStudioVersion
        # 2. given (1.) determins VC20##Project
        # note - other file of perl - https://github.com/postgres/postgres/blob/master/src/tools/msvc/VSObjectFactory.pm
        #
        dir
        perl contrib\plr\buildsetup.pl
        pwd
        dir
        type plr.vcxproj
        type pgcrypto.vcxproj
        type C:\projects\postgresql\pgsql.sln
        popd
        $env:PROJ="C:\projects\postgresql\pgsql.sln"
        $env:dll="c:\projects\postgresql\$env:CONFIGURATION\plr\plr.dll"
      } else {
        echo no effect on the 2019 two plr project problem
        move plr.vcxproj.user.hidden plr.vcxproj.user
        move plr.vcxproj.hidden      plr.vcxproj
        $env:PROJ="plr.vcxproj"
        $env:dll="$($env:PLATFORM.replace('x86', '.'))\$env:CONFIGURATION\plr.dll"
        if (-not (Test-Path "$env:pgroot\bin")) {
          if (-not (Test-Path "$env:exe")) {
            Start-FileDownload "http://get.enterprisedb.com/postgresql/$env:exe"
          }
          & ".\$env:exe" --unattendedmodeui none --mode unattended --superpassword "$env:PGPASSWORD" --servicepassword "$env:PGPASSWORD" | Out-Null
          Stop-Service "postgresql$env:x64-$env:pgversion"
        }
      }
  - REM END install

  cache:
  - '%exe%'
  - R-%rversion%-win.exe

  build_script:
  - REM BEGIN build_script
  - REM verbosity levels: q[uiet], m[inimal], n[ormal] (default), d[etailed], and diag[nostic]
  - msbuild /p:PlatformToolset=%PlatformToolset% /p:configuration=%CONFIGURATION% /p:platform=%PLATFORM%
            %PROJ%
            /verbosity:normal /logger:"C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"
  - dir
  - REM END build_script

  after_build:
  - REM BEGIN after_build
  - appveyor AddMessage Packing -Category Information
  - md tmp\share\extension
  - copy *.sql tmp\share\extension\
  - copy *.control tmp\share\extension\
  - copy LICENSE tmp\PLR_LICENSE
  - md tmp\lib
  - md tmp\symbols
  - copy %dll% tmp\lib
  - copy %dll:.dll=.pdb% tmp\symbols
  - dir tmp
  - set zip=plr-%APPVEYOR_REPO_COMMIT:~0,8%-pg%pgversion%-R%rversion%-%PLATFORM%-%CONFIGURATION%-%msvc_diff_file%.zip
  - 7z a -r %zip% .\tmp\* > nul
  - ps: |
      Set-PSDebug -Trace 2
      if ("$env:pg" -eq "master") {
        pushd c:\projects\postgresql\src\tools\msvc
        perl install.pl "$env:pgroot"
        popd
      }
  - dir
  - REM END after_build

  test_script:
  - REM BEGIN test_script
  - path %pgroot%\bin;%PATH%
  - ps: |
      Set-PSDebug -Trace 2
      # if ("$env:pg" -eq "master") {
      if (("master", "13.0.0-0", "12.0.0-0", "11.0.0-0").Contains("$env:pg")) {
        Set-Content -path pg.pass -value "$env:pgpassword" -encoding ascii
        initdb -A md5 -U "$env:PGUSER" --pwfile=pg.pass C:\pgdata
        pg_ctl register -S demand -N "postgresql$env:x64-$env:pgversion" -D c:\pgdata
      } else {
        Add-AppveyorMessage "Copying the extension files to the PostgreSQL directories." -Category Information
        7z x "$env:zip" "-o$env:pgroot"
      }
  - appveyor AddMessage "Starting the database server." -Category Information
  - setx /M PATH "%R_HOME%\bin\%RBIN%;%PATH%"
  - net start postgresql%x64%-%pgversion%

  - ps: |
      Set-PSDebug -Trace 2
      Add-AppveyorTest Regression -Framework pg_regress -FileName sql\ -Outcome Running
      if (("9.3", "9.4").Contains("$env:pgversion")) {
        $env:psqlopt="--psqldir"
      } else {
        $env:psqlopt="--bindir"
      }
      $env:Outcome="Passed"
      $elapsed=(Measure-Command {
        pg_regress "$env:psqlopt=$env:pgroot\bin" --dbname=pl_regression plr `
          bad_fun opt_window do out_args 2>&1 |
          %{ if ($_ -is [System.Management.Automation.ErrorRecord]) { $_.Exception.Message } else { $_ } } |
            Out-Default
        if ($LASTEXITCODE -ne 0) {
          $env:Outcome="Failed"
        }
      }).TotalMilliseconds
      Update-AppVeyorTest Regression -Framework pg_regress -FileName sql\ -Outcome "$env:Outcome" -Duration $elapsed
      if ("$env:Outcome" -ne "Passed") {
        type regression.diffs
        $host.SetShouldExit($LastExitCode)
      }
  - dir
  - REM END test_script

  artifacts:
  - path: 'plr-*.zip'
    name: plr_zip

  deploy:
    - provider: GitHub
      release: plr-$(APPVEYOR_BUILD_VERSION)
      draft: false
      prerelease: false
      auth_token:
        secure: KzS1DumC2yBg2LGN9x3AemHFOjAdp+rD58rW5aGGpwW4Pfdwdm7AmRpYKprPY8Gs
      artifact: plr_zip
  #   on:
  #     appveyor_repo_tag: true

    - provider: FTP
      host: frs.sourceforge.net
      protocol: sftp
      username: andremikulec,andremikulec.u
      password:
        secure: 4gk4GyW4O5RooiOyGeRdoA==
      artifact: plr_zip
      folder: /home/frs/project/andremikulec
      application:
      active_mode: false


  # I run my jobs manually
  # I do not want my email filling up
  notifications:
    - provider: Email
      on_build_success: false
      on_build_failure: false
      on_build_status_changed: false

-
  matrix:
    only:
      - USER_BUILD: MSYS2

  init:
   - echo initializing something
   - echo %USER_BUILD%

  install:
  - echo installing something
  - set

  build_script:
  - echo building nothing

